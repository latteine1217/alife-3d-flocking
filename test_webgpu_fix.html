<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGPU ç²’å­æ¸¬è©¦</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #0a0a0a;
            color: #fff;
            font-family: monospace;
        }
        #canvas {
            border: 2px solid #333;
            display: block;
            margin: 20px auto;
        }
        #status {
            text-align: center;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 14px;
            cursor: pointer;
        }
        #log {
            background: #111;
            padding: 10px;
            border: 1px solid #333;
            height: 200px;
            overflow-y: scroll;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>WebGPU ç²’å­æ¸²æŸ“æ¸¬è©¦</h1>
    
    <div id="status">
        <p>WebSocket: <span id="ws-status">æœªé€£æ¥</span></p>
        <p>ç²’å­æ•¸: <span id="particle-count">0</span></p>
        <p>å¹€æ•¸: <span id="frame-count">0</span></p>
        <button onclick="connect()">é€£æ¥ä¼ºæœå™¨</button>
        <button onclick="start()">é–‹å§‹æ¨¡æ“¬</button>
    </div>
    
    <canvas id="canvas" width="800" height="600"></canvas>
    
    <div id="log"></div>

    <script type="module">
        let ws = null;
        let particleCount = 0;
        let frameCount = 0;

        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        window.connect = async function() {
            try {
                log('ğŸ”„ æ­£åœ¨é€£æ¥åˆ° ws://localhost:8765...');
                ws = new WebSocket('ws://localhost:8765');
                ws.binaryType = 'arraybuffer';

                ws.onopen = () => {
                    log('âœ… WebSocket é€£æ¥æˆåŠŸ');
                    document.getElementById('ws-status').textContent = 'å·²é€£æ¥';
                    document.getElementById('ws-status').style.color = '#48bb78';
                };

                ws.onmessage = (event) => {
                    if (event.data instanceof ArrayBuffer) {
                        handleBinaryData(event.data);
                    } else {
                        log('ğŸ“¨ æ”¶åˆ° JSON: ' + event.data);
                    }
                };

                ws.onerror = (error) => {
                    log('âŒ WebSocket éŒ¯èª¤');
                    document.getElementById('ws-status').textContent = 'éŒ¯èª¤';
                    document.getElementById('ws-status').style.color = '#fc8181';
                };

                ws.onclose = () => {
                    log('ğŸ”Œ WebSocket å·²é—œé–‰');
                    document.getElementById('ws-status').textContent = 'æœªé€£æ¥';
                    document.getElementById('ws-status').style.color = '#fff';
                };
            } catch (error) {
                log('âŒ é€£æ¥å¤±æ•—: ' + error.message);
            }
        };

        window.start = function() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('âŒ è«‹å…ˆé€£æ¥åˆ°ä¼ºæœå™¨');
                return;
            }
            log('â–¶ï¸ ç™¼é€ start å‘½ä»¤...');
            ws.send(JSON.stringify({ type: 'start' }));
        };

        function handleBinaryData(buffer) {
            frameCount++;
            
            // è§£æ header
            const view = new DataView(buffer);
            const N = view.getUint32(0, true);
            const step = view.getUint32(4, true);
            
            if (N !== particleCount) {
                particleCount = N;
                document.getElementById('particle-count').textContent = N;
                log(`ğŸ“Š ç²’å­æ•¸æ›´æ–°: N=${N}`);
            }
            
            document.getElementById('frame-count').textContent = frameCount;
            
            // æ¯ç§’è¨˜éŒ„ä¸€æ¬¡
            if (frameCount % 30 === 0) {
                log(`âœ… ç¬¬ ${frameCount} å¹€: N=${N}, step=${step}, buffer=${buffer.byteLength} bytes`);
                
                // è®€å–ç¬¬ä¸€å€‹ç²’å­çš„ä½ç½®
                const offset = 20; // header size
                const x = view.getFloat32(offset, true);
                const y = view.getFloat32(offset + 4, true);
                const z = view.getFloat32(offset + 8, true);
                log(`   ç²’å­[0]: (${x.toFixed(2)}, ${y.toFixed(2)}, ${z.toFixed(2)})`);
            }
        }

        // è‡ªå‹•é€£æ¥
        log('ğŸš€ é é¢è¼‰å…¥å®Œæˆ');
        log('ğŸ‘‰ é»æ“Šã€Œé€£æ¥ä¼ºæœå™¨ã€æŒ‰éˆ•é–‹å§‹');
    </script>
</body>
</html>
